{% extends 'public/base_cpanel.html' %}

{% block title %}Generar Código de Acceso{% endblock %}

{% block customCSS %}
<link rel="stylesheet" href="{{ url_for('static', filename='assets/css/generar-clave.css') }}">
{% endblock %}

{% block body %}
<!-- Header Section - Mismo estilo que las demás páginas -->
<div class="card border-0 shadow-sm p-4 mb-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
      <h3 class="mb-1 fw-bold text-dark">Control de Acceso 2FA</h3>
      <p class="text-muted mb-0">Genera un código temporal para acceder al Data Center</p>
    </div>
  </div>
</div>

<div class="key-page">

  <!-- Grid de dos métodos -->
  <div class="key-grid">

    <!-- Método 1: Teclado 4x4 + RFID -->
    <div class="access-card">
      <div class="access-card-header">
        <div class="access-card-icon keypad">
          <i class="bi bi-grid-3x3-gap-fill"></i>
        </div>
        <div class="access-card-info">
          <h3>Teclado 4x4 + Tarjeta RFID</h3>
          <p>Código de 4 dígitos + tarjeta física</p>
        </div>
      </div>

      <div class="access-card-body">
        <div class="code-display-wrapper">
          <div class="code-label">Tu código de acceso</div>

          <div class="code-digits" id="codeDigits">
            <div class="code-digit empty" id="digit1">—</div>
            <div class="code-digit empty" id="digit2">—</div>
            <div class="code-digit empty" id="digit3">—</div>
            <div class="code-digit empty" id="digit4">—</div>
          </div>

          <div class="keypad-instructions" id="keypadInstructions" style="display: none;">
            <i class="bi bi-keyboard"></i>
            <span>Ingresa este código en el teclado matricial</span>
          </div>

          <div class="expiration-badge" id="expirationBadge" style="display: none;">
            <i class="bi bi-clock"></i>
            <span>Válido por <span class="time" id="expirationTime">5:00</span></span>
          </div>
        </div>

        <div class="factor-badge" id="factorBadge" style="display: none;">
          <i class="bi bi-check-circle-fill"></i>
          <span>Luego presenta tu tarjeta RFID para completar</span>
        </div>

        <button type="button" class="btn-generate primary" id="generateKeypadBtn"
          onclick="generarCodigoTeclado('{{dataLogin.id}}')">
          <i class="bi bi-lightning-charge-fill"></i>
          Generar Código
        </button>
      </div>
    </div>

    <!-- Método 2: Código + Autorización Remota -->
    <div class="access-card">
      <div class="access-card-header">
        <div class="access-card-icon remote">
          <i class="bi bi-broadcast"></i>
        </div>
        <div class="access-card-info">
          <h3>Autorización Remota</h3>
          <p>Código + aprobación del administrador</p>
        </div>
      </div>

      <div class="access-card-body">
        <div class="remote-auth-section">
          <div class="remote-status" id="remoteStatus">
            <div class="remote-status-icon idle" id="remoteIcon">
              <i class="bi bi-hourglass"></i>
            </div>
            <h4 id="remoteTitle">Sin solicitud activa</h4>
            <p id="remoteMessage">Genera un código para solicitar autorización al administrador</p>
          </div>

          <div class="code-display-wrapper" id="remoteCodeWrapper" style="display: none;">
            <div class="code-label">Código enviado al admin</div>
            <div class="code-digits" id="remoteCodeDigits">
              <div class="code-digit empty" id="remoteDigit1">—</div>
              <div class="code-digit empty" id="remoteDigit2">—</div>
              <div class="code-digit empty" id="remoteDigit3">—</div>
              <div class="code-digit empty" id="remoteDigit4">—</div>
            </div>
          </div>
        </div>

        <button type="button" class="btn-generate secondary" id="generateRemoteBtn"
          onclick="solicitarAutorizacion('{{dataLogin.id}}')">
          <i class="bi bi-send-fill"></i>
          Solicitar Autorización
        </button>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block customJS %}
<script>
  // Variables globales
  let countdownInterval = null;

  // ===== MÉTODO 1: Teclado 4x4 + RFID =====
  function generarCodigoTeclado(userId) {
    const btn = document.getElementById('generateKeypadBtn');
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generando...';
    btn.disabled = true;

    // Simular llamada al backend (reemplazar con fetch real)
    fetch("/generar-y-guardar-clave/" + userId)
      .then(response => response.text())
      .then(data => {
        const codigo = data.trim().substring(0, 4).toUpperCase();
        mostrarCodigo(codigo);
        iniciarTemporizador(300); // 5 minutos

        btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Generar Nuevo';
        btn.disabled = false;
      })
      .catch(error => {
        console.error("Error:", error);
        btn.innerHTML = '<i class="bi bi-lightning-charge-fill"></i> Generar Código';
        btn.disabled = false;
      });
  }

  function mostrarCodigo(codigo) {
    const digitos = codigo.split('');

    for (let i = 0; i < 4; i++) {
      const digitBox = document.getElementById('digit' + (i + 1));
      digitBox.classList.remove('empty');
      digitBox.classList.add('generated');

      // Animación escalonada
      setTimeout(() => {
        digitBox.textContent = digitos[i] || '0';
      }, i * 100);
    }

    // Mostrar instrucciones y badge
    document.getElementById('keypadInstructions').style.display = 'flex';
    document.getElementById('factorBadge').style.display = 'inline-flex';
    document.getElementById('expirationBadge').style.display = 'inline-flex';
  }

  function iniciarTemporizador(segundos) {
    if (countdownInterval) clearInterval(countdownInterval);

    let restante = segundos;
    const timerElement = document.getElementById('expirationTime');

    function actualizar() {
      const min = Math.floor(restante / 60);
      const seg = restante % 60;
      timerElement.textContent = min + ':' + String(seg).padStart(2, '0');

      if (restante <= 0) {
        clearInterval(countdownInterval);
        expirarCodigo();
      }
      restante--;
    }

    actualizar();
    countdownInterval = setInterval(actualizar, 1000);
  }

  function expirarCodigo() {
    for (let i = 1; i <= 4; i++) {
      const digitBox = document.getElementById('digit' + i);
      digitBox.classList.remove('generated');
      digitBox.classList.add('empty');
      digitBox.textContent = '—';
    }
    document.getElementById('keypadInstructions').style.display = 'none';
    document.getElementById('factorBadge').style.display = 'none';
    document.getElementById('expirationBadge').style.display = 'none';
  }

  // ===== MÉTODO 2: Autorización Remota =====
  let currentRequestId = null;
  let statusPollingInterval = null;

  function solicitarAutorizacion(userId) {
    const btn = document.getElementById('generateRemoteBtn');
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Enviando...';
    btn.disabled = true;

    // Llamar a la API real
    fetch("/api/solicitar-acceso", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: userId })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          currentRequestId = data.requestId;
          mostrarSolicitudEnviada(data.code);
          iniciarPollingEstado(data.requestId);

          // Mostrar notificación de que se envió
          if (typeof Toast !== 'undefined') {
            Toast.info('Solicitud Enviada', 'Esperando aprobación del administrador');
          }
        } else {
          throw new Error(data.error || 'Error al solicitar');
        }

        btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Solicitar de Nuevo';
        btn.disabled = false;
      })
      .catch(error => {
        console.error("Error:", error);
        btn.innerHTML = '<i class="bi bi-send-fill"></i> Solicitar Autorización';
        btn.disabled = false;

        if (typeof Toast !== 'undefined') {
          Toast.error('Error', 'No se pudo enviar la solicitud');
        }
      });
  }

  function mostrarSolicitudEnviada(codigo) {
    // Actualizar estado visual
    const icon = document.getElementById('remoteIcon');
    icon.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    icon.classList.remove('idle', 'approved', 'rejected');
    icon.classList.add('waiting');

    document.getElementById('remoteTitle').textContent = 'Esperando aprobación...';
    document.getElementById('remoteMessage').textContent = 'El administrador ha recibido tu solicitud';

    // Mostrar código
    document.getElementById('remoteCodeWrapper').style.display = 'block';
    const digitos = codigo.split('');

    for (let i = 0; i < 4; i++) {
      const digitBox = document.getElementById('remoteDigit' + (i + 1));
      digitBox.classList.remove('empty');
      digitBox.classList.add('generated');

      setTimeout(() => {
        digitBox.textContent = digitos[i] || '0';
      }, i * 100);
    }
  }

  function iniciarPollingEstado(requestId) {
    // Limpiar polling anterior
    if (statusPollingInterval) {
      clearInterval(statusPollingInterval);
    }

    // Verificar estado cada 2 segundos
    statusPollingInterval = setInterval(() => {
      fetch('/api/estado-solicitud/' + requestId)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.processed) {
            clearInterval(statusPollingInterval);

            if (data.approved) {
              mostrarAprobacion();
            } else {
              mostrarRechazo();
            }
          }
        })
        .catch(err => console.log('Polling error:', err.message));
    }, 2000);

    // Timeout después de 5 minutos
    setTimeout(() => {
      if (statusPollingInterval) {
        clearInterval(statusPollingInterval);
        mostrarExpirado();
      }
    }, 300000);
  }

  function mostrarAprobacion() {
    const icon = document.getElementById('remoteIcon');
    icon.innerHTML = '<i class="bi bi-check-lg"></i>';
    icon.classList.remove('waiting', 'idle', 'rejected');
    icon.classList.add('approved');

    document.getElementById('remoteTitle').textContent = '¡Autorización Aprobada!';
    document.getElementById('remoteMessage').textContent = 'Ya puedes ingresar al Data Center';

    // Notificación de éxito
    if (typeof Toast !== 'undefined') {
      Toast.success('¡Aprobado!', 'El administrador ha autorizado tu acceso');
    }
  }

  function mostrarRechazo() {
    const icon = document.getElementById('remoteIcon');
    icon.innerHTML = '<i class="bi bi-x-lg"></i>';
    icon.classList.remove('waiting', 'idle', 'approved');
    icon.classList.add('rejected');

    document.getElementById('remoteTitle').textContent = 'Solicitud Rechazada';
    document.getElementById('remoteMessage').textContent = 'El administrador no autorizó el acceso';

    // Notificación
    if (typeof Toast !== 'undefined') {
      Toast.warning('Rechazado', 'Tu solicitud de acceso fue denegada');
    }
  }

  function mostrarExpirado() {
    const icon = document.getElementById('remoteIcon');
    icon.innerHTML = '<i class="bi bi-clock"></i>';
    icon.classList.remove('waiting', 'approved', 'rejected');
    icon.classList.add('idle');

    document.getElementById('remoteTitle').textContent = 'Solicitud Expirada';
    document.getElementById('remoteMessage').textContent = 'El tiempo de espera ha terminado';
  }
</script>
{% endblock %}