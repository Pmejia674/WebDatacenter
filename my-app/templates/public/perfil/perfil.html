{% extends 'public/base_cpanel.html' %}
{% block title %}InfraNova | Mi Perfil{% endblock %}

{% block body %}
<!-- Header Section -->
<div class="card border-0 shadow-sm p-4 mb-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
    <div>
      <h3 class="mb-1 fw-bold text-dark">Mi Perfil</h3>
      <p class="text-muted mb-0">Administra tu información personal y seguridad</p>
    </div>
    <div class="d-flex align-items-center gap-2">
      <div class="rounded-circle bg-blue-subtle p-3 d-flex align-items-center justify-content-center text-primary"
        style="width: 50px; height: 50px;">
        <i class="bi bi-person-fill fs-4"></i>
      </div>
      <div>
        <span class="fw-semibold text-dark">{{ info_perfil_session[0]['nombre_usuario'] }} {{
          info_perfil_session[0]['apellido_usuario'] }}</span>
        <div class="text-muted small">{{ info_perfil_session[0]['cedula'] }}</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Información Personal -->
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
        <div class="d-flex align-items-center gap-2">
          <div class="rounded-circle bg-blue-subtle p-2 d-flex align-items-center justify-content-center text-primary"
            style="width: 36px; height: 36px;">
            <i class="bi bi-person-vcard"></i>
          </div>
          <h5 class="mb-0 fw-semibold">Información Personal</h5>
        </div>
      </div>
      <div class="card-body p-4">
        <form method="POST" action="{{ url_for('actualizarPerfil', id=info_perfil_session[0]['id_usuario']) }}">
          <div class="mb-3">
            <label for="cedula" class="form-label text-muted text-uppercase small fw-semibold">Cédula</label>
            <input class="form-control bg-light" type="text" name="cedula"
              value="{{ info_perfil_session[0]['cedula'] }}" readonly />
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="name" class="form-label text-muted text-uppercase small fw-semibold">Nombre</label>
              <input type="text" name="name" value="{{ info_perfil_session[0]['nombre_usuario'] }}" class="form-control"
                required />
            </div>
            <div class="col-md-6 mb-3">
              <label for="surname" class="form-label text-muted text-uppercase small fw-semibold">Apellido</label>
              <input class="form-control" type="text" name="surname"
                value="{{ info_perfil_session[0]['apellido_usuario'] }}" />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="area" class="form-label text-muted text-uppercase small fw-semibold">Área</label>
              <select class="form-select" name="selectArea" {% if dataLogin.rol==2 %} disabled {% endif %}>
                {% for area in areas %}
                {% if area.id_area == info_perfil_session[0]['id_area'] %}
                <option value="{{ area.id_area }}" selected>{{ area.nombre_area }}</option>
                {% else %}
                <option value="{{ area.id_area }}">{{ area.nombre_area }}</option>
                {% endif %}
                {% endfor %}
              </select>
              {% if dataLogin.rol != 1 %}
              <input name="selectArea" value="{{ info_perfil_session[0]['id_area'] }}" hidden>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label for="rol" class="form-label text-muted text-uppercase small fw-semibold">Rol</label>
              <select class="form-select" name="selectRol" {% if dataLogin.rol==2 %} disabled {% endif %}>
                {% for rol in roles %}
                {% if rol.id_rol == info_perfil_session[0]['id_rol'] %}
                <option value="{{ rol.id_rol }}" selected>{{ rol.nombre_rol }}</option>
                {% else %}
                <option value="{{ rol.id_rol }}">{{ rol.nombre_rol }}</option>
                {% endif %}
                {% endfor %}
              </select>
              {% if dataLogin.rol != 1 %}
              <input name="selectRol" value="{{ info_perfil_session[0]['id_rol'] }}" hidden>
              {% endif %}
            </div>
          </div>

          <div class="d-grid mt-2">
            <button type="submit" class="btn btn-primary d-flex align-items-center justify-content-center gap-2">
              <i class="bi bi-check-lg"></i>
              <span>Guardar Cambios</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Seguridad -->
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-header bg-transparent border-0 pt-4 pb-0 px-4">
        <div class="d-flex align-items-center gap-2">
          <div class="rounded-circle bg-blue-subtle p-2 d-flex align-items-center justify-content-center text-primary"
            style="width: 36px; height: 36px;">
            <i class="bi bi-shield-lock"></i>
          </div>
          <h5 class="mb-0 fw-semibold">Seguridad</h5>
        </div>
      </div>
      <div class="card-body p-4">
        <form method="POST" action="{{ url_for('actualizarPerfil', id=info_perfil_session[0]['id_usuario']) }}">
          <!-- Hidden fields para mantener datos actuales -->
          <input type="hidden" name="cedula" value="{{ info_perfil_session[0]['cedula'] }}">
          <input type="hidden" name="name" value="{{ info_perfil_session[0]['nombre_usuario'] }}">
          <input type="hidden" name="surname" value="{{ info_perfil_session[0]['apellido_usuario'] }}">
          <input type="hidden" name="selectArea" value="{{ info_perfil_session[0]['id_area'] }}">
          <input type="hidden" name="selectRol" value="{{ info_perfil_session[0]['id_rol'] }}">

          <div class="alert alert-light border-0 bg-blue-subtle mb-4" role="alert">
            <div class="d-flex gap-2">
              <i class="bi bi-info-circle text-primary"></i>
              <small class="text-primary">Deja los campos vacíos si no deseas cambiar la contraseña</small>
            </div>
          </div>

          {% if dataLogin.rol == info_perfil_session[0]['id_rol'] %}
          <div class="mb-3">
            <label class="form-label text-muted text-uppercase small fw-semibold" for="pass_actual">Contraseña
              Actual</label>
            <div class="input-group">
              <input type="password" class="form-control" name="pass_actual" id="pass_actual"
                placeholder="Ingresa tu contraseña actual" />
              <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('pass_actual', this)">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>
          {% endif %}

          <div class="mb-3">
            <label class="form-label text-muted text-uppercase small fw-semibold" for="new_pass_user">Nueva
              Contraseña</label>
            <div class="input-group">
              <input type="password" class="form-control" name="new_pass_user" id="new_pass_user"
                placeholder="Ingresa la nueva contraseña" />
              <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('new_pass_user', this)">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>

          {% if dataLogin.rol == info_perfil_session[0]['id_rol'] %}
          <div class="mb-3">
            <label class="form-label text-muted text-uppercase small fw-semibold" for="repetir_pass_user">Confirmar
              Nueva Contraseña</label>
            <div class="input-group">
              <input type="password" class="form-control" name="repetir_pass_user" id="repetir_pass_user"
                placeholder="Repite la nueva contraseña" />
              <button class="btn btn-outline-secondary" type="button"
                onclick="togglePassword('repetir_pass_user', this)">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>
          {% endif %}

          <div class="d-grid mt-4">
            <button type="submit"
              class="btn btn-outline-primary d-flex align-items-center justify-content-center gap-2">
              <i class="bi bi-key"></i>
              <span>Actualizar Contraseña</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    if (input.type === 'password') {
      input.type = 'text';
      icon.classList.remove('bi-eye');
      icon.classList.add('bi-eye-slash');
    } else {
      input.type = 'password';
      icon.classList.remove('bi-eye-slash');
      icon.classList.add('bi-eye');
    }
  }
</script>
{% endblock %}