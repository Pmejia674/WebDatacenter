{% extends 'public/base_cpanel.html' %}
{% block title %}Lista de Usuarios{% endblock %}

{% block body %}
{% if (resp_usuariosBD) %}
<div class="modern-card">
  <div class="card-header-modern">
    <h3 class="card-title-modern">Lista de Usuarios</h3>
    <a href="./register-user" class="btn-primary-modern">
      <i class="bi bi-plus-lg"></i>
      Nuevo Usuario
    </a>
  </div>
  
  <div class="datatables-controls">
    <div class="datatables-length">
      <select id="lengthSelect" class="form-select-sm">
        <option value="10">10 registros</option>
        <option value="25">25 registros</option>
        <option value="50">50 registros</option>
        <option value="-1">Todos</option>
      </select>
    </div>
    <div class="datatables-search">
      <i class="bi bi-search"></i>
      <input type="text" id="searchInput" placeholder="Buscar usuarios..." />
    </div>
  </div>
  
  <div class="modern-table-wrapper table-responsive">
    <table class="modern-table table-hover js-datatable" id="tablaUsuarios" data-has-actions="true" data-options='{"responsive": false, "dom": "rt"}'>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Cédula</th>
          <th>Área</th>
          <th>Rol</th>
          <th style="text-align: right;">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for usuario in resp_usuariosBD %}
        <tr>
          <td>
            <span style="font-weight: 500;">{{ usuario.nombre_usuario}} {{usuario.apellido_usuario}}</span>
          </td>
          <td>
            <span style="font-family: monospace; font-size: 0.875rem;">{{ usuario.cedula}}</span>
          </td>
          <td>
            {%for area in areas%}
            {%if area.id_area == usuario.id_area%}
            <span class="badge-modern badge-blue">{{area.nombre_area}}</span>
            {%endif%}
            {%endfor%}
          </td>
          <td>
            {% for rol in roles%}
            {% if rol.id_rol == usuario.id_rol%}
            <span class="badge-modern {% if rol.nombre_rol == 'Administrador' %}badge-purple{% else %}badge-gray{% endif %}">
              {{ rol.nombre_rol}}
            </span>
            {%endif%}
            {%endfor%}
          </td>
          <td style="text-align: right;">
            <a href="/mi-perfil/{{usuario.id_usuario}}" class="btn-action btn-edit" title="Editar">
              <i class="bi bi-pencil"></i>
            </a>
            <a onclick="eliminarUsuario('{{ usuario.id_usuario }}');" class="btn-action btn-delete" style="cursor: pointer;" title="Eliminar">
              <i class="bi bi-trash3"></i>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <div class="datatables-controls">
    <div id="tableInfo" class="dataTables_info"></div>
    <div id="tablePagination" class="dataTables_paginate"></div>
  </div>
</div>
{% else %}
<div class="modern-card">
  <div class="empty-state">
    <div class="empty-state-icon">
      <i class="bi bi-people"></i>
    </div>
    <p class="empty-state-text">No hay usuarios registrados</p>
    <p style="color: var(--color-text-muted); margin-top: 0.5rem;">Comienza agregando tu primer usuario</p>
    <a href="./register-user" class="btn-primary-modern" style="margin-top: 1.5rem;">
      <i class="bi bi-plus-lg"></i>
      Agregar Usuario
    </a>
  </div>
</div>
{% endif %}
{% endblock %}

{% block customJS %}
<script>
  function eliminarUsuario(id) {
    if (confirm("¿Estás seguro que deseas eliminar este usuario? Esta acción no se puede deshacer.")) {
      window.location.href = `/borrar-usuario/${id}`;
    }
  }
  
  $(document).ready(function() {
    setTimeout(function() {
      var table = $('#tablaUsuarios').DataTable();
      
      $('#searchInput').on('keyup', function() {
        table.search(this.value).draw();
      });
      
      $('#lengthSelect').on('change', function() {
        table.page.len(this.value).draw();
      });
      
      table.on('draw', function() {
        var info = table.page.info();
        $('#tableInfo').html('Mostrando ' + (info.start + 1) + ' a ' + info.end + ' de ' + info.recordsTotal + ' usuarios');
        
        var html = '';
        var currentPage = info.page;
        var pages = info.pages;
        
        html += '<button class="paginate_button ' + (currentPage === 0 ? 'disabled' : '') + '" data-page="prev">Anterior</button>';
        
        for (var i = 0; i < pages; i++) {
          if (i === 0 || i === pages - 1 || (i >= currentPage - 1 && i <= currentPage + 1)) {
            html += '<button class="paginate_button ' + (i === currentPage ? 'current' : '') + '" data-page="' + i + '">' + (i + 1) + '</button>';
          } else if (i === currentPage - 2 || i === currentPage + 2) {
            html += '<span class="ellipsis">...</span>';
          }
        }
        
        html += '<button class="paginate_button ' + (currentPage === pages - 1 ? 'disabled' : '') + '" data-page="next">Siguiente</button>';
        
        $('#tablePagination').html(html);
      });
      
      $('#tablePagination').on('click', '.paginate_button:not(.disabled)', function() {
        var page = $(this).data('page');
        if (page === 'prev') {
          table.page('previous').draw('page');
        } else if (page === 'next') {
          table.page('next').draw('page');
        } else {
          table.page(page).draw('page');
        }
      });
      
      table.draw();
    }, 100);
  });
</script>
{% endblock %}
